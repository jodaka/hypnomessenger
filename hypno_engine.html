<html><head></head>
<body>
<canvas id="canvas" style="display: none"></canvas>
<!--<script src="js/lang.js" type="text/javascript"></script>-->
<script src="js/jquery.js" type="text/javascript"></script>
<script type="text/javascript">
//function reset_icon() {
//    chrome.extension.sendRequest({action: 'reset_icon'});
//}

var Hypno = {
    version: -1,
    auth_and_register: false,  // this flag shows that we have Authorized (on google) and Registered on Android

    Init: function(ver) {
        Hypno.version = ver;
        // draw loading
        // initializing urls
        Hypno.Urls.Init();
        // get contacts list
        Hypno.Contacts.Init();
        
        chrome.browserAction.onClicked.addListener(Hypno.OpenGui()); 
    },

    // open popup
    OpenGui: function() {
        console.log('OPEN POPUP clicked');
        chrome.browserAction.setPopup({
            popup: "hypno_gui.html"
        });
    },
    
    OpenAuth: function() {
        chrome.tabs.create({url: Hypno.Urls.signIn});
    },

    Notifications: {
        Icon: function(action, msg) {
            if (action == 'new') {
                chrome.browserAction.setBadgeText({text: String(msg)});
                chrome.browserAction.setTitle({title: chrome.i18n.getMessage('_icon_new_messages')});
                // bind click to go to new messages
            }
            if (action == 'auth') {
                chrome.browserAction.setBadgeText({text: '!'});
                chrome.browserAction.setTitle({title: chrome.i18n.getMessage('_icon_authorization_fail')});
                // remove popup listener
                chrome.browserAction.onClicked.removeListener(Hypno.OpenGui());
                // bind click to go signin page
                chrome.browserAction.onClicked.addListener(function(){Hypno.OpenAuth()});
            }
            if (action == 'register') {
                chrome.browserAction.setBadgeText({text: '!'});
                chrome.browserAction.setTitle({title: chrome.i18n.getMessage('_icon_not_registered')});
            }
        }
    },

    Messages: {
        iniated: false,

        Init: function() {
            if (Hypno.auth_and_register) {
                if (!Hypno.Messages.iniated) {
                    Hypno.Messages.Incoming.Load();
                    Hypno.Messages.Outgoing.Load();

                    // check for new MSG every 30 sec
                    Hypno.Messages.Incoming.timer = setInterval(function(){
                        console.log('Checking for new messages...');
                        Hypno.Messages.Incoming.Load();
                    }, 30000);

                    Hypno.Messages.iniated = true;
                }
            } else {
                clearInterval(Hypno.Messages.Incoming.timer);
            }
        },

        // this holds last 50 messages history 
        Outgoing: {
            list: [],
            Load: function() {
                jQuery.ajax({
                    url: Hypno.Urls.messages.get.outgoing,
                    dataType: 'json',
                    complete: function(data) {
                        var json = {};

                        try {
                            json = eval('('+data['responseText']+')');  // obj = this.getResponseJSON();
                        } catch (err) {
                            console.warn(err);
                            return false;
                        }

                        if (JSON.stringify(Hypno.Messages.Outgoing.list) != JSON.stringify(json.message_list.slice(0))) {
                            console.log('==> got history messages');
                            Hypno.Messages.Outgoing.list = json.message_list.slice(0);
                            window.localStorage.setItem('Hypno_outgoing_list', JSON.stringify(Hypno.Messages.Outgoing.list));
                        }
                        return 1;
                    }
                });
            }
        },

        Incoming: {
            list        : [],
            viewed      : [],
            timer       : false,

            Load: function() {
                console.log('... getting incoming messages');
                jQuery.ajax({
                    url: Hypno.Urls.messages.get.unread+'&status=0',
                    dataType: 'json',
                    complete: function(data) {
                        var json = {};

                        try {
                            json = eval('('+data['responseText']+')');  // obj = this.getResponseJSON();
                        } catch (err) {
                            console.warn(err);
                            return false;
                        }

                        if (JSON.stringify(Hypno.Messages.Incoming.list) != JSON.stringify(json.sms_list.slice(0))) {
                            console.log('==> got new incoming messages');
                            Hypno.Messages.Incoming.list = json.sms_list.slice(0);
                            window.localStorage.setItem('Hypno_incoming_list', JSON.stringify(Hypno.Messages.Incoming.list));
                            Hypno.Notifications.Icon('new', Hypno.Messages.Incoming.list.length);
                            // TODO FIXME
                            // check if main screen is active and send signal to redraw contact list
                        }
                        return 1;
                    }
                });
                jQuery.ajax({
                    url: Hypno.Urls.messages.get.viewed,
                    dataType: 'json',
                    complete: function(data) {
                        var json = {};
                        try {
                            json = eval('('+data['responseText']+')');  // obj = this.getResponseJSON();
                        } catch (err) {
                            console.warn(err);
                            console.warn(data);
                            return false;
                        }

                        if (Hypno.Messages.Incoming.viewed != json.sms_list.slice(0)) {
                            Hypno.Messages.Incoming.viewed  = json.sms_list.slice(0);
                            window.localStorage.setItem('Hypno_incoming_viewed', JSON.stringify(Hypno.Messages.Incoming.viewed));
                        }
                        return 1;
                    }
                });
            }
        },

        // this will hold SMS that were already sent by web interface
        Sent: {
            queue_process_timer: false,
            queue: [],
            GetStatus: function(collapse_key) {
                jQuery.ajax({
                    url: Hypno.Urls.send_status+collapse_key,
                    dataType: 'json',
                    complete: function(data) {
                        try {
                            json = eval('('+data['responseText']+')');  // obj = this.getResponseJSON();
                        } catch (err) {
                            console.warn(err);
                            return false;
                        }

                        if (json.status == "OK") {
                            // message was sent. Now we need to check periodically for
                            // it's status
                            Hypno.Messages.Sent.MarkAsDelivered(collapse_key);
                            return 1;
                        }

                        if (json.status == "SIGNIN_REQUIRED") {
                            window.location.href = Hypno.Urls.signIn;
                            return 1;
                        }
                    }
                });
            },

            ProcessQueue: function() {
                var queue = Hypno.Messages.Sent.queue;
                if (queue.length == 0) return 0;
                for (var i = 0; i < queue.length; i++) {
                    Hypno.Messages.Sent.GetStatus(queue[i]);
                }
            },

            MarkAsDelivered: function(collapse_key) {
                var items = Hypno.Messages.History.items;
                for (var i = 0; i < items.length; i++) {
                    if (items[i].collapsekey == collapse_key) {
                        items[i].status = 'delivered';
                        Hypno.Messages.History.Store();
                        break;
                    }
                }
                
                // delete from queue
                var queue = Hypno.Messages.Sent.queue;
                queue = queue.splice(queue.indexOf(collapse_key), 1);
                Hypno.Messages.Sent.queue = queue;
            }
        }
    },

    Contacts: {
        list    : [],
        timer   : false,

        Init: function() {
            Hypno.Contacts.Load();

            // every 1m we check contacts list and auth
            Hypno.Contacts.timer = setInterval(function(){
                console.log('Checking contacts list and Auth...');
                Hypno.Contacts.Load();
            }, 60000);
        },

        Load: function() {
            console.log('... Contacts sending request');
            jQuery.ajax({
                url: Hypno.Urls.contacts,
                dataType: 'json',
                complete: function(data) {
                    var json = {};

                    try {
                        json = eval('('+data['responseText']+')');  // obj = this.getResponseJSON();
                    } catch (err) {
                        console.warn(err);
                        return false;
                    }

                    if (json.status == "OK") {
                        Hypno.auth_and_register = true;

                        if (JSON.stringify(Hypno.Contacts.list) != JSON.stringify(json.contact_list)) {
                            console.log('==> got new contacts list');
                            window.localStorage.setItem('Hypno_contacts', JSON.stringify(json.contact_list));
                            Hypno.Contacts.list = json.contact_list;
                            // TODO FIXME
                            // send signal to main window to update contacts list
                        }

                        // getting messages from server
                        Hypno.Messages.Init();
                        return 1;
                    }

                    if (json.status == "SIGNIN_REQUIRED") {
                        console.log('... SIGNIN_REQUIRED');
                        Hypno.auth_and_register = false;
                        Hypno.Notifications.Icon('auth', 0);
                        Hypno.Messages.Init();
                        return 1;
                    }

                    if (json.status == "DEVICE_NOT_REGISTERED") {
                        console.log('... DEVICE_NOT_REGISTERED');
                        Hypno.auth_and_register = false;
                        Hypno.Notifications.Icon('register', 0);
                        Hypno.Messages.Init();
                        return 1;
                    }
                }
            });
        },
    },

    Urls: {
        appEngine   : false,
        signIn      : false,
        signOut     : false,
        contacts    : false,
        send        : false,
        index       : chrome.extension.getURL('close.html'),

        Init: function() {
            Hypno.Urls.appEngine   = "http://"+Hypno.version+".latest.bandog812.appspot.com/";
            Hypno.Urls.signIn      = Hypno.Urls.appEngine+"sign?action=signin&extret="+encodeURIComponent(Hypno.Urls.index)+"&ver="+Hypno.version;
            Hypno.Urls.signOut     = Hypno.Urls.appEngine+"sign?action=signout&extret=OK&ver="+Hypno.version;
            Hypno.Urls.contacts    = Hypno.Urls.appEngine+"contacts_list?action=get&ver="+Hypno.version;
            Hypno.Urls.send        = Hypno.Urls.appEngine+"message?action=send&ver="+Hypno.version;
            Hypno.Urls.send_status = Hypno.Urls.appEngine+"message?action=get_status&ver="+Hypno.version+'&collapse_key=';
            

            Hypno.Urls.messages = {
                'get': {
                    unread  : Hypno.Urls.appEngine+"sms?action=get&ver="+Hypno.version,
                    viewed  : Hypno.Urls.appEngine+"sms?action=get&status=30&from=0&to=10&ver="+Hypno.version,
                    outgoing: Hypno.Urls.appEngine+'message?action=get&ver='+Hypno.version
                }
            };
        }
    }
}

chrome.browserAction.setTitle({title: chrome.i18n.getMessage('name')});
Hypno.Init(6);

</script>
<!-- Written just for fun by Anton Kudris (aka jodaka) kudris@gmail.com -->
</body></html>
