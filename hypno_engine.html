<html><head></head><body>
<script src="js/jquery.js" type="text/javascript"></script>
<script type="text/javascript">
var Hypno = {
    version: -1,
    auth_and_register: false,  // this flag shows that we have Authorized (on google) and Registered on Android

    Init: function(ver) {
        Hypno.version = ver;
        // draw loading
        // initializing urls
        Hypno.Urls.Init();
        // get contacts list
        Hypno.Contacts.Init();
        
        // add listener to communicate with popup page
        chrome.extension.onRequest.addListener(
            function(request, sender, sendResponse) {
                console.log('~~~~~> ENGINE got signal'+request['action']);
                if (request['action'] == 'message_sent') {
                    Hypno.Actions.MessageSent(request);
                }
                if (request['action'] == 'reload_data') {
                    Hypno.Contacts.Load();
                    Hypno.Messages.Load();
                }
                if (request['action'] == 'signout') {
                    Hypno.Actions.Signout();
                }
            }
        );

        chrome.browserAction.setPopup({
            popup: "hypno_gui.html"
        });
    },

    Actions: {
        
        Signout: function() {
            console.log('Signout called. All data cleared');
            window.localStorage.setItem('Hypno_status', 'auth');
            Hypno.Messages.list = {
                incoming: [],
                outgoing: [],
                history : [],
                viewed  : []
            };
            window.localStorage.setItem('Hypno_messages_incoming', JSON.stringify(Hypno.Messages.list.incoming));
            window.localStorage.setItem('Hypno_messages_outgoing', JSON.stringify(Hypno.Messages.list.outgoing));
            window.localStorage.setItem('Hypno_messages_viewed', JSON.stringify(Hypno.Messages.list.viewed));
            window.localStorage.setItem('Hypno_messages_history', JSON.stringify(Hypno.Messages.list.history));
            clearInterval(Hypno.Messages.Incoming.timer);
            Hypno.Messages.Incoming.timer = false;
            Hypno.Contacts.list = [];
        },

        MessageSent: function(request) {
            console.warn('Message sent detected');
            console.log(request);
            if (request.hasOwnProperty('message')) {
                Hypno.Messages.list.outgoing.push(request.message);
                Hypno.Messages.MergeLists();
                Hypno.Messages.Store();
                chrome.extension.sendRequest({action: 'reload_data'});
            }
        },

        NewMessagesAvailable: function() {
            window.localStorage.setItem('Hypno_status', 'ok');
            if (Hypno.Messages.list.incoming.length > 0) {
                Hypno.Notifications.Icon('new', Hypno.Messages.list.incoming.length);
            } else {
                Hypno.Notifications.Icon('new', '');
            }

            //Hypno.Messages.Store(); // do we really need it here?? FIXME
            
            // bind click to go to new messages
            //chrome.browserAction.setPopup({
            //    popup: "hypno_gui.html"
            //});
        },

        DeviceNotRegistered: function() {
            Hypno.auth_and_register = false;
            Hypno.Notifications.Icon('register');
            window.localStorage.setItem('Hypno_status', 'device_not_registered');
            // clear event listeners
            chrome.browserAction.onClicked.listeners = [];
            //chrome.browserAction.setPopup({
            //    popup: "hypno_gui.html"
            //});
        },

        NotAuthorized: function() {
            Hypno.auth_and_register = false;
            console.log('Binded Auth to icon click');
            window.localStorage.setItem('Hypno_status', 'auth');
            // clear event listeners
            chrome.browserAction.onClicked.listeners = [];
        }
    },

    Notifications: {
        Icon: function(action, msg) {
            if (action == 'new') {
                chrome.browserAction.setBadgeText({text: String(msg)});
                chrome.browserAction.setTitle({title: chrome.i18n.getMessage('_icon_new_messages')});
                
            }
            if (action == 'auth') {
                chrome.browserAction.setBadgeText({text: '!'});
                chrome.browserAction.setTitle({title: chrome.i18n.getMessage('_icon_authorization_fail')});
                
            }
            if (action == 'register') {
                chrome.browserAction.setBadgeText({text: '!'});
                chrome.browserAction.setTitle({title: chrome.i18n.getMessage('_icon_not_registered')});
            }
        }
    },

    Messages: {
        iniated: false,
        list: {
            incoming: [],
            outgoing: [],
            viewed  : [],
            history : []
        },

        BindReloadTimer: function() {
            console.log(' => messages reloading timer binded');
            Hypno.Messages.Incoming.timer = setInterval(function(){
                console.log('Checking for new messages...');
                //console.log(Hypno);
                Hypno.Messages.Load();
            }, 15000);
        },

        Init: function() {
            Hypno.Messages.list = {
                incoming: JSON.parse(window.localStorage.getItem('Hypno_messages_incoming')),
                outgoing: JSON.parse(window.localStorage.getItem('Hypno_messages_outgoing')),
                viewed  : JSON.parse(window.localStorage.getItem('Hypno_messages_viewed')),
                history : [],
            };

            if (Hypno.auth_and_register) {
                if (!Hypno.Messages.iniated) {
                    Hypno.Messages.Load();
                    // check for new MSG every 30 sec
                    if (!Hypno.Messages.Incoming.timer) Hypno.Messages.BindReloadTimer();
                    Hypno.Messages.iniated = true;
                }
            } else {
                clearInterval(Hypno.Messages.Incoming.timer);
                Hypno.Messages.Incoming.timer = false;
            }
        },

        // creates huge history list from combined incoming/outgoing
        MergeLists: function() {
            console.log('merge called');
            var local = {
                incoming: Hypno.Messages.list.incoming,
                outgoing: Hypno.Messages.list.outgoing,
                viewed: Hypno.Messages.list.viewed,
                history: [],
            };
            local.history = local.viewed.slice();

            for (var n = 0; n < local.incoming.length; n++) {
                var inserted = false;
                for (var h = 0; h < local.history.length; h++) {
                    if (local.history[h].create_time > local.incoming[n].create_time) {
                        continue;
                    } else {
                        inserted = true;
                        local.history.splice(h, 0, local.incoming[n]);
                        break;
                    }
                }
                if (!inserted) local.history.push(local.incoming[n]);
            }

            // 2)
            // merge outgoing with incoming
            for (var n = 0, max = local.outgoing.length; n < max; n++) {
                var inserted = false;
                for (var h = 0; h < local.history.length; h++) {
                    if (local.history[h].create_time > local.outgoing[n].create_time) {
                        continue;
                    } else {
                        inserted = true;
                        if (local.history instanceof Array) {
                            local.history.splice(h, 0, local.outgoing[n]);
                            break;
                        } else {
                            inserted = true;
                            console.error('WTF!?');
                            break;
                        }
                        
                    }
                }
                if (!inserted) local.history.push(local.outgoing[n]);

            }

            Hypno.Messages.list.history = local.history.slice();
            window.localStorage.setItem('Hypno_messages_history', JSON.stringify(Hypno.Messages.list.history));
        },

        Load: function(){
            
            console.log(' Messages.Load() called');
            
            jQuery.when(
                jQuery.ajax({
                    url: Hypno.Urls.messages.get.unread+'&status=0',
                    dataType: 'json'
                }),
                jQuery.ajax({
                    url: Hypno.Urls.messages.get.viewed,
                    dataType: 'json'
                }),
                jQuery.ajax({
                    url: Hypno.Urls.messages.get.outgoing,
                    dataType: 'json'
                })
            ).done(function(ajax_new_list, ajax_viewed_list, ajax_outgoing_list){

                var local = {
                    incoming: [],
                    viewed  : [],
                    outgoing: [],
                    history : []
                };

                if (ajax_new_list[1] == 'success')      local.incoming  = ajax_new_list[0].sms_list.slice();
                if (ajax_viewed_list[1] == 'success')   local.viewed    = ajax_viewed_list[0].sms_list.slice();
                if (ajax_outgoing_list[1] == 'success') local.outgoing  = ajax_outgoing_list[0].message_list.slice();

                //console.log([ajax_new_list, ajax_viewed_list, ajax_outgoing_list]);

                var merge_needed = 0;

                // handling of new messages
                if (JSON.stringify(Hypno.Messages.list.incoming) != JSON.stringify(local.incoming)) {
                    console.log('... got new messages');
                    Hypno.Messages.list.incoming = local.incoming.slice();
                    Hypno.Actions.NewMessagesAvailable();
                    window.localStorage.setItem('Hypno_messages_incoming', JSON.stringify(Hypno.Messages.list.incoming));
                    merge_needed = 1;
                }

                // handling of viewed incoming messages
                if (JSON.stringify(Hypno.Messages.list.viewed) != JSON.stringify(local.viewed)) {
                    console.log('... got incoming messages');
                    Hypno.Messages.list.viewed = local.viewed.slice();
                    window.localStorage.setItem('Hypno_messages_viewed', JSON.stringify(Hypno.Messages.list.viewed));
                    merge_needed = 1;
                }

                // handling of outgoing messages
                if (JSON.stringify(Hypno.Messages.list.outgoing) != JSON.stringify(local.outgoing)) {
                    console.log('... got outgoing messages');
                    Hypno.Messages.list.outgoing = local.outgoing.slice();
                    window.localStorage.setItem('Hypno_messages_outgoing', JSON.stringify(Hypno.Messages.list.outgoing));
                    merge_needed = 1;
                }

                if (merge_needed || Hypno.Messages.list.history.length == 0) {
                    chrome.extension.sendRequest({action: 'reload_lists'});
                    Hypno.Messages.MergeLists();
                }
            });
        },

        Incoming: {
            timer       : false,
            //
            //Load: function() {
            //    jQuery.ajax({
            //        url: Hypno.Urls.messages.get.unread+'&status=0',
            //        dataType: 'json',
            //        complete: function(data) {
            //            var json = {};
            //
            //            try {
            //                json = eval('('+data['responseText']+')');  // obj = this.getResponseJSON();
            //            } catch (err) {
            //                console.warn(err);
            //                return false;
            //            }
            //
            //            if (JSON.stringify(Hypno.Messages.list.incoming) != JSON.stringify(json.sms_list.slice(0))) {
            //                console.log('==> got new incoming messages');
            //                Hypno.Messages.list.incoming = json.sms_list.slice(0);
            //                window.localStorage.setItem('Hypno_incoming_list', JSON.stringify(Hypno.Messages.list.incoming));
            //                Hypno.Actions.NewMessagesAvailable();
            //                Hypno.Messages.MergeLists();
            //                // TODO FIXME
            //                // check if main screen is active and send signal to redraw contact list
            //            }
            //            return 1;
            //        }
            //    });
            //}
        },

        // this will hold SMS that were already sent by web interface

        Store: function() {
            window.localStorage.setItem('Hypno_messages_incoming',  JSON.stringify(Hypno.Messages.list.incoming));
            window.localStorage.setItem('Hypno_messages_viewed',    JSON.stringify(Hypno.Messages.list.viewed));
            window.localStorage.setItem('Hypno_messages_outgoing',  JSON.stringify(Hypno.Messages.list.outgoing));
            window.localStorage.setItem('Hypno_messages_history',   JSON.stringify(Hypno.Messages.list.history));
        },
        
        Sent: {
            queue_process_timer: false,
            queue: [],
            GetStatus: function(collapse_key) {
                jQuery.ajax({
                    url: Hypno.Urls.send_status+collapse_key,
                    dataType: 'json',
                    complete: function(data) {
                        try {
                            json = eval('('+data['responseText']+')');  // obj = this.getResponseJSON();
                        } catch (err) {
                            console.warn(err);
                            return false;
                        }

                        if (json.status == "OK") {
                            // message was sent. Now we need to check periodically for
                            // it's status
                            Hypno.Messages.Sent.MarkAsDelivered(collapse_key);
                            return 1;
                        }

                    }
                });
            },

            ProcessQueue: function() {
                var queue = Hypno.Messages.Sent.queue;
                if (queue.length == 0) return 0;
                for (var i = 0; i < queue.length; i++) {
                    Hypno.Messages.Sent.GetStatus(queue[i]);
                }
            },

            MarkAsDelivered: function(collapse_key) {
                var items = Hypno.Messages.History.items;
                for (var i = 0; i < items.length; i++) {
                    if (items[i].collapsekey == collapse_key) {
                        items[i].status = 'delivered';
                        Hypno.Messages.History.Store();
                        break;
                    }
                }
                
                // delete from queue
                var queue = Hypno.Messages.Sent.queue;
                queue = queue.splice(queue.indexOf(collapse_key), 1);
                Hypno.Messages.Sent.queue = queue;
            }
        }
    },

    Contacts: {
        list    : [],
        timer   : false,

        Init: function() {
            Hypno.Contacts.Load();

            // every 1m we check contacts list and auth
            Hypno.Contacts.timer = setInterval(function(){
                console.log('Checking contacts list and Auth...');
                Hypno.Contacts.Load();
            }, 60000);
        },

        Load: function() {
            console.log('... Contacts sending request');
            jQuery.ajax({
                url: Hypno.Urls.contacts,
                dataType: 'json',
                complete: function(data) {
                    var json = {};

                    try {
                        json = eval('('+data['responseText']+')');  // obj = this.getResponseJSON();
                    } catch (err) {
                        console.warn(err);
                        return false;
                    }

                    if (json.status == "OK") {
                        Hypno.auth_and_register = true;

                        if (JSON.stringify(Hypno.Contacts.list) != JSON.stringify(json.contact_list)) {
                            console.log('==> got new contacts list');
                            window.localStorage.setItem('Hypno_contacts', JSON.stringify(json.contact_list));
                            Hypno.Contacts.list = json.contact_list;
                            window.localStorage.setItem('Hypno_status', 'ok');
                            // send signal to main window to update contacts list
                            chrome.extension.sendRequest({action: 'reload_contacts'});
                        }

                        // this handle login/logout timer handling
                        if (!Hypno.Messages.Incoming.timer) Hypno.Messages.BindReloadTimer();

                        // getting messages from server
                        Hypno.Messages.Init();
                        return 1;
                    }

                    if (json.status == "SIGNIN_REQUIRED") {
                        console.log('... SIGNIN_REQUIRED');
                        Hypno.Actions.NotAuthorized();
                        Hypno.Actions.Signout();
                        return 1;
                    }

                    if (json.status == "DEVICE_NOT_REGISTERED") {
                        console.log('... DEVICE_NOT_REGISTERED');
                        Hypno.Actions.DeviceNotRegistered();
                        Hypno.Messages.Init();
                        return 1;
                    }
                }
            });
        },
    },

    Urls: {
        appEngine   : false,
        signIn      : false,
        signOut     : false,
        contacts    : false,
        send        : false,
        index       : chrome.extension.getURL('close.html'),

        Init: function() {
            Hypno.Urls.appEngine   = "http://"+Hypno.version+".latest.bandog812.appspot.com/";
            Hypno.Urls.signIn      = Hypno.Urls.appEngine+"sign?action=signin&extret="+encodeURIComponent(Hypno.Urls.index)+"&ver="+Hypno.version;
            Hypno.Urls.signOut     = Hypno.Urls.appEngine+"sign?action=signout&extret=OK&ver="+Hypno.version;
            Hypno.Urls.contacts    = Hypno.Urls.appEngine+"contacts_list?action=get&ver="+Hypno.version;
            Hypno.Urls.send        = Hypno.Urls.appEngine+"message?action=send&ver="+Hypno.version;
            Hypno.Urls.send_status = Hypno.Urls.appEngine+"message?action=get_status&ver="+Hypno.version+'&collapse_key=';

            Hypno.Urls.messages = {
                'get': {
                    unread  : Hypno.Urls.appEngine+"sms?action=get&ver="+Hypno.version,
                    viewed  : Hypno.Urls.appEngine+"sms?action=get&status=30&from=0&to=10&ver="+Hypno.version,
                    outgoing: Hypno.Urls.appEngine+'message?action=get&ver='+Hypno.version
                }
            };
        }
    }
}

chrome.browserAction.setTitle({title: chrome.i18n.getMessage('name')});
Hypno.Init(6);

</script>
<!-- Written just for fun by Anton Kudris (aka jodaka) kudris@gmail.com -->
</body></html>
