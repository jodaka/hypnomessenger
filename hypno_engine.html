<html><head></head><body>
<script src="js/jquery.js" type="text/javascript"></script>
<script src="js/socket.io.js" type="text/javascript"></script>
<script type="text/javascript">
"use strict";  // voices in my head forced me to write this

var Hypno = {
    params: {
        debug       : false,
        version     : -1,
    },

    auth_and_reg: false,    // this flag shows that we have
                            // Auth (on google) and Registration on Android

    // console.log wrapper then only spams in debug mode
    log: function(o) {
        if (Hypno.params.debug&&window.console&&console.log)
            console.log(o);
    },

    Init: function(params) {
        Hypno.params  = params;

        // initializing urls
        Hypno.Urls.Init();

        // add listener to communicate with popup page
        chrome.extension.onRequest.addListener(
            function(request, sender, sendResponse) {
                Hypno.log('ENGINE: ~~~> got GUI signal'+request['action']);
                switch(request['action']) {
                    case 'message_sent':
                        Hypno.Actions.MessageSent(request)
                    break;

                    case 'reload_data':
                        Hypno.Contacts.Load();
                        Hypno.Messages.Load();
                    break;

                    case 'signout':
                        Hypno.Actions.Signout();
                    break;

                    case 'checkAuthReg':
                        Hypno.Actions.checkAuthAndReg()
                    break;

                    default:
                    
                    break;
                }
            }
        );

        chrome.browserAction.setPopup({
            popup: "hypno_gui.html"
        });

        // get user email and fio
        jQuery.when(
            jQuery.ajax({
                url: Hypno.Urls.status,
                dataType: 'json'
            })
        ).done(function(res) {
            if (!(typeof(res) === "object" && res.hasOwnProperty('status'))) {
                console.warn(res);
                return false;
            }
            // check status 
            Hypno.Actions.checkStatus(res.status);
            // save username and email
            Hypno.params.userid     = res.email;
            Hypno.params.username   = res.nickName;
            Hypno.params.userkey    = '123456789'; // TO BE FIXED one day
            if (Hypno.auth_and_reg) {
                console.log('OLA');
                Hypno.Contacts.Load();
                Hypno.ws.init();
            }
        });
    },

    Actions: {
        // this function is called from gui
        // every time a popup is open
        // it just check then we have auth and reg
        checkAuthAndReg: function() {
            jQuery.ajax({
                url: Hypno.Urls.status,
                dataType: 'json',
                complete: function(res) {
                    try {
                        json = eval('('+res['responseText']+')');  // obj = this.getResponseJSON();
                    } catch (err) {
                        console.warn(err);
                        return false;
                    }

                    Hypno.Actions.checkStatus(json.status);
                }
            });
        },
        
        checkStatus: function(status) {

            switch (status) {
                    case 'OK':
                        var stored_status = window.localStorage.getItem('Hypno_status');
                        if (stored_status != 'ok' || !Hypno.auth_and_reg) {
                            Hypno.Actions.Registered();
                        }
                        return true;
                    break;

                    case 'DEVICE_NOT_REGISTERED':
                        Hypno.Actions.DeviceNotRegistered();
                        return 0;
                    break;

                    case 'SIGNIN_REQUIRED':
                        Hypno.Actions.NotAuthorized();
                        Hypno.Actions.Signout();
                        return 0;
                    break;

                    default:
                        console.error('ENGINE: UNKNOWN STATUS '+status);
                        return false;
                }

        },
        
        Signout: function() {
            Hypno.log('ENGINE: Signout called. All data cleared');
            Hypno.Notifications.Icon('clear');
            window.localStorage.setItem('Hypno_status', 'auth');
            Hypno.Messages.list = {
                incoming: [],
                outgoing: [],
                history : [],
                viewed  : []
            };
            window.localStorage.setItem('Hypno_messages_incoming', JSON.stringify(Hypno.Messages.list.incoming));
            window.localStorage.setItem('Hypno_messages_outgoing', JSON.stringify(Hypno.Messages.list.outgoing));
            window.localStorage.setItem('Hypno_messages_viewed', JSON.stringify(Hypno.Messages.list.viewed));
            window.localStorage.setItem('Hypno_messages_history', JSON.stringify(Hypno.Messages.list.history));
            
            //clearInterval(Hypno.Messages.incoming_timer);
            //Hypno.Messages.incoming_timer = false;
            Hypno.Contacts.list = [];
        },

        MessageSent: function(request) {
            console.warn('ENGINE: Message sent detected');
            if (request.hasOwnProperty('message')) {
                Hypno.Messages.list.outgoing.push(request.message);
                Hypno.Messages.MergeLists();
                Hypno.Messages.Store();
                chrome.extension.sendRequest({action: 'reload_data'});
            }
        },

        //ClearMessageReloadTimer: function() {
        //    clearInterval(Hypno.Messages.incoming_timer);
        //    Hypno.Messages.incoming_timer = false;
        //},

        NewMessagesAvailable: function() {
            window.localStorage.setItem('Hypno_status', 'ok');
            Hypno.log('ENGINE: ++ NewMessagesAvailable fired');
            if (Hypno.Messages.list.incoming.length > 0) {
                Hypno.Notifications.Icon('new', Hypno.Messages.list.incoming.length);
            } else {
                Hypno.Notifications.Icon('clear');
            }
        },

        DeviceNotRegistered: function() {
            Hypno.log('ENGINE: ... DEVICE_NOT_REGISTERED');
            Hypno.auth_and_reg = false;
            Hypno.Notifications.Icon('register');
            window.localStorage.setItem('Hypno_status', 'device_not_registered');
            chrome.extension.sendRequest({action: 'not_registered'});
            // clear event listeners
            chrome.browserAction.onClicked.listeners = [];
            //Hypno.Actions.ClearMessageReloadTimer();
        },

        Registered: function() {
            Hypno.log('ENGINE: ... DEVICE_REGISTERED');
            Hypno.auth_and_reg = true;
            Hypno.Notifications.Icon('clear');
            window.localStorage.setItem('Hypno_status', 'ok');
            chrome.extension.sendRequest({action: 'registered'});
        },

        NotAuthorized: function() {
            Hypno.log('ENGINE: ... SIGNIN_REQUIRED');
            Hypno.auth_and_reg = false;
            Hypno.log('ENGINE: Binded Auth to icon click');
            window.localStorage.setItem('Hypno_status', 'auth');
            // clear event listeners
            chrome.browserAction.onClicked.listeners = [];
            //Hypno.Actions.ClearMessageReloadTimer();
        }
    },

    Notifications: {
        Icon: function(action, msg) {
            //Hypno.log('ENGINE: Notify.Icon called action='+action);
            if (action == 'new') {
                chrome.browserAction.setBadgeText({text: String(msg)});
                chrome.browserAction.setTitle({title: chrome.i18n.getMessage('_icon_new_messages')});
                
            }
            if (action == 'auth') {
                chrome.browserAction.setBadgeText({text: '!'});
                chrome.browserAction.setTitle({title: chrome.i18n.getMessage('_icon_authorization_fail')});
            }
            if (action == 'register') {
                chrome.browserAction.setBadgeText({text: '!'});
                chrome.browserAction.setTitle({title: chrome.i18n.getMessage('_icon_not_registered')});
            }
            if (action == 'clear') {
                chrome.browserAction.setBadgeText({text: ''});
                chrome.browserAction.setTitle({title: chrome.i18n.getMessage('_icon_authorization_fail')});
            }
        }
    },

    Messages: {
        iniated: false,
        //incoming_timer: false,
        list: {
            incoming: [],
            outgoing: [],
            viewed  : [],
            history : []
        },

        //BindReloadTimer: function() {
        //    //Hypno.log('ENGINE:  => messages reloading timer binded');
        //    Hypno.Messages.incoming_timer = setInterval(function(){
        //        //Hypno.log('ENGINE: Checking for new messages...');
        //        Hypno.Messages.Load();
        //    }, 10000);
        //},

        Init: function() {
            Hypno.Messages.list = {
                incoming: JSON.parse(window.localStorage.getItem('Hypno_messages_incoming')),
                outgoing: JSON.parse(window.localStorage.getItem('Hypno_messages_outgoing')),
                viewed  : JSON.parse(window.localStorage.getItem('Hypno_messages_viewed')),
                history : [],
            };

            if (Hypno.auth_and_reg) {
                if (!Hypno.Messages.iniated) {
                    Hypno.Messages.Load();
                    // check for new MSG every 30 sec
                    //if (!Hypno.Messages.incoming_timer) Hypno.Messages.BindReloadTimer();
                    Hypno.Messages.iniated = true;
                }
            }
            //else {
            //    clearInterval(Hypno.Messages.incoming_timer);
            //    Hypno.Messages.incoming_timer = false;
            //}
        },

        // creates huge history list from combined incoming/outgoing
        MergeLists: function() {
            return 1;
            Hypno.log('ENGINE: merge called');
            var local = {
                incoming: Hypno.Messages.list.incoming,
                outgoing: Hypno.Messages.list.outgoing,
                viewed: Hypno.Messages.list.viewed,
                history: [],
            };
            local.history = local.viewed.slice();

            for (var n = 0; n < local.incoming.length; n++) {
                var inserted = false;
                for (var h = 0; h < local.history.length; h++) {
                    if (local.history[h].create_time > local.incoming[n].create_time) {
                        continue;
                    } else {
                        inserted = true;
                        local.history.splice(h, 0, local.incoming[n]);
                        break;
                    }
                }
                if (!inserted) local.history.push(local.incoming[n]);
            }

            // 2)
            // merge outgoing with incoming
            for (var n = 0, max = local.outgoing.length; n < max; n++) {
                var inserted = false;
                for (var h = 0; h < local.history.length; h++) {
                    if (local.history[h].create_time > local.outgoing[n].create_time) {
                        continue;
                    } else {
                        inserted = true;
                        if (local.history instanceof Array) {
                            local.history.splice(h, 0, local.outgoing[n]);
                            break;
                        } else {
                            inserted = true;
                            console.error('WTF!?');
                            break;
                        }
                        
                    }
                }
                if (!inserted) local.history.push(local.outgoing[n]);

            }

            Hypno.Messages.list.history = local.history.slice();
            window.localStorage.setItem('Hypno_messages_history', JSON.stringify(Hypno.Messages.list.history));
        },

        Load: function(){

            //Hypno.log('ENGINE:  Messages.Load() called');
            jQuery.when(
                jQuery.ajax({
                    url: Hypno.Urls.messages.get.unread+'&status=0',
                    dataType: 'json'
                })
            ).done(function(ajax_new_list){
                var new_sms = [];
                if (!Hypno.Actions.checkStatus(ajax_new_list['status'])) {
                    console.warn('ENGINE: status FAIL');
                    return false;
                }
                new_sms = ajax_new_list.sms_list.slice();
                //if (new_sms.length > 0 || Hypno.Messages.list.incoming.length != new_sms.length) Hypno.Actions.NewMessagesAvailable();

                Hypno.Actions.NewMessagesAvailable();

                // handling of new messages
                if (JSON.stringify(Hypno.Messages.list.incoming) != JSON.stringify(new_sms)) {
                    //Hypno.Actions.NewMessagesAvailable();
                    Hypno.Messages.list.incoming = new_sms.slice();
                    window.localStorage.setItem('Hypno_messages_incoming', JSON.stringify(Hypno.Messages.list.incoming));
                    chrome.extension.sendRequest({action: 'reload_lists'});
                }
            });
        },
        // this will hold SMS that were already sent by web interface

        Store: function() {
            window.localStorage.setItem('Hypno_messages_incoming',  JSON.stringify(Hypno.Messages.list.incoming));
            window.localStorage.setItem('Hypno_messages_viewed',    JSON.stringify(Hypno.Messages.list.viewed));
            window.localStorage.setItem('Hypno_messages_outgoing',  JSON.stringify(Hypno.Messages.list.outgoing));
            window.localStorage.setItem('Hypno_messages_history',   JSON.stringify(Hypno.Messages.list.history));
        },
        
        Sent: {
            //queue_process_timer: false,
            queue: [],
            GetStatus: function(collapse_key) {
                jQuery.ajax({
                    url: Hypno.Urls.send_status+collapse_key,
                    dataType: 'json',
                    complete: function(data) {
                        try {
                            json = eval('('+data['responseText']+')');  // obj = this.getResponseJSON();
                        } catch (err) {
                            console.warn(err);
                            return false;
                        }

                        if (json.status == "OK") {
                            // message was sent. Now we need to check periodically for
                            // it's status
                            Hypno.Messages.Sent.MarkAsDelivered(collapse_key);
                            return 1;
                        }

                    }
                });
            },

            ProcessQueue: function() {
                var queue = Hypno.Messages.Sent.queue;
                if (queue.length == 0) return 0;
                for (var i = 0; i < queue.length; i++) {
                    Hypno.Messages.Sent.GetStatus(queue[i]);
                }
            },

            MarkAsDelivered: function(collapse_key) {
                var items = Hypno.Messages.History.items;
                for (var i = 0; i < items.length; i++) {
                    if (items[i].collapsekey == collapse_key) {
                        items[i].status = 'delivered';
                        Hypno.Messages.History.Store();
                        break;
                    }
                }
                
                // delete from queue
                var queue = Hypno.Messages.Sent.queue;
                queue = queue.splice(queue.indexOf(collapse_key), 1);
                Hypno.Messages.Sent.queue = queue;
            }
        }
    },

    Contacts: {
        list    : [],
        //timer   : false,

        Init: function() {
            Hypno.Contacts.Load();
            // every 1m we check contacts list 
            //Hypno.Contacts.timer = setInterval(function(){
            //    Hypno.log('ENGINE: Reloading contacts list');
            //    Hypno.Contacts.Load();
            //}, 60000);
        },

        Load: function() {
            //Hypno.log('ENGINE: ... Contacts sending request');
            jQuery.ajax({
                url: Hypno.Urls.contacts,
                dataType: 'json',
                complete: function(data) {
                    var json = {};

                    try {
                        json = eval('('+data['responseText']+')');  // obj = this.getResponseJSON();
                    } catch (err) {
                        console.warn(err);
                        return false;
                    }

                    if (Hypno.Actions.checkStatus(json.status)) {
                        Hypno.auth_and_reg = true;

                        if (!Hypno.auth_and_reg) {
                            Hypno.Actions.Registered();
                        }

                        if (JSON.stringify(Hypno.Contacts.list) != JSON.stringify(json.contact_list)) {
                            Hypno.log('ENGINE: ==> got new contacts list');
                            window.localStorage.setItem('Hypno_contacts', JSON.stringify(json.contact_list));
                            Hypno.Contacts.list = json.contact_list;
                            window.localStorage.setItem('Hypno_status', 'ok');
                            // send signal to main window to update contacts list
                            chrome.extension.sendRequest({action: 'reload_contacts'});
                        }

                        // this handle login/logout timer handling
                        //if (!Hypno.Messages.incoming_timer) Hypno.Messages.BindReloadTimer();

                        // getting messages from server
                        Hypno.Messages.Init();
                        return 1;
                    }
                }
            });
        },
    },

    Urls: {
        appEngine   : false,
        signIn      : false,
        signOut     : false,
        contacts    : false,
        send        : false,
        index       : chrome.extension.getURL('close.html'),
        websocket   : {
            port: 80,
            host: false
        },

        Init: function() {
            Hypno.Urls.appEngine   = "http://"+Hypno.params.version+".latest.bandog812.appspot.com/";
            Hypno.Urls.signIn      = Hypno.Urls.appEngine+"sign?action=signin&extret="+encodeURIComponent(Hypno.Urls.index)+"&ver="+Hypno.params.version;
            Hypno.Urls.signOut     = Hypno.Urls.appEngine+"sign?action=signout&extret=OK&ver="+Hypno.params.version;
            Hypno.Urls.status      = Hypno.Urls.appEngine+"sign?action=check&ver="+Hypno.params.version;
            Hypno.Urls.contacts    = Hypno.Urls.appEngine+"contacts_list?action=get&ver="+Hypno.params.version;
            Hypno.Urls.send        = Hypno.Urls.appEngine+"message?action=send&ver="+Hypno.params.version;
            Hypno.Urls.send_status = Hypno.Urls.appEngine+"message?action=get_status&ver="+Hypno.params.version+'&collapse_key=';
            Hypno.Urls.websocket.port = Hypno.params.ws_port;
            Hypno.Urls.websocket.host = Hypno.params.ws_host;

            Hypno.Urls.messages = {
                'get': {
                    unread  : Hypno.Urls.appEngine+"sms?action=get&ver="+Hypno.params.version,
                    viewed  : Hypno.Urls.appEngine+"sms?action=get&status=30&from=0&to=10&ver="+Hypno.params.version,
                    outgoing: Hypno.Urls.appEngine+'message?action=get&ver='+Hypno.params.version
                }
            };
        }
    },

    // websocket layer
    ws: {
        socket: false,
        debug : false,
        auth  : false,
        params: {},

        // Connection Manager. Can initiate WS connection,
        // send messages
        // and authorize client on server
        conn: {
            init: function() {
                if (Hypno.ws.socket) {
                    Hypno.log('already connected to socket');
                    return 0;
                }
                try {
                    Hypno.ws.socket = new io.Socket(Hypno.Urls.websocket.host, {
                        port: Hypno.Urls.websocket.port,
                        rememberTransport: true
                    });
                    Hypno.ws.socket.connect();
                } catch(e) {
                    Hypno.log('error connecting to socket');
                    Hypno.log(e);
                    return 0;
                }
                Hypno.ws.bind_handlers();     // binding response handlers
                return 1;
            },
    
            // checks for auth.
            // if called without params - will try to send auth request
            // 
            auth: function(msg) {
                if (!msg) {
                    Hypno.log('sending auth request');
                    Hypno.ws.conn.send({
                        type: 'auth',
                        key : Hypno.params.userkey,
                        id  : Hypno.params.userid
                    });
                } else {
                    if (msg.hasOwnProperty('type') && msg.type == 'auth') {
                        if (msg.data.hasOwnProperty('value') && msg.data.value) {
                            Hypno.ws.auth = true;
                            Hypno.log('Auth granted');
                        } else {
                            Hypno.ws.auth = false;
                            Hypno.log('Auth rejected');
                        }
                    } else {
                        Hypno.log('Warning: can\'t parser auth response');
                        Hypno.log(msg);
                    }
                }
            },

            // sending data to server over ws
            send: function(o) {
                try {
                    Hypno.ws.socket.send(o);
                } catch(e) {
                    Hypno.log(e);
                }
                return 1;
            },
        },

        bind_handlers: function() {
            Hypno.log('binding handlers');
            // binding handlers
            Hypno.ws.socket.on('message', function(msg){
                if (msg.hasOwnProperty('type')) {
                    switch (msg.type) {
                        case 'auth':
                            Hypno.log('<--- AUTH response');
                            Hypno.ws.conn.auth(msg);
                            return 1;
                        break;

                        case 'SMS':
                            Hypno.log('<--- SMS');
                            Hypno.ws.notify.sms(msg);
                            return 1;
                        break;

                        case 'MESSAGE':
                            Hypno.log('<--- MESSAGE');
                            Hypno.ws.notify.message(msg);
                            return 1;
                        break;

                        case 'CONTACT_LIST':
                            Hypno.log('<--- MESSAGE');
                            Hypno.ws.notify.contact_list(msg);
                            return 1;
                        break;

                        case 'DEVICE_REGISTERED':
                            Hypno.log('<--- DEV_REGISTERED');
                            Hypno.ws.notify.registered(msg);
                            return 1;
                        break;

                        case 'DEVICE_NOT_REGISTERED':
                            Hypno.log('<--- DEV_NOT_REGISTERED');
                            Hypno.ws.notify.not_registered(msg);
                            return 1;
                        break;

                        default:
                            Hypno.log('<--- unknown message');
                            Hypno.log(msg);
                            return 1;
                        break;
                    }
                } else {
                    Hypno.log('Warning: message doesn\'t has type. Don\'t know how to parse');
                    Hypno.log(msg);
                    return 0;
                }
            });

            Hypno.ws.socket.on('connect', function(){
                Hypno.log('~~~ websocket connected');
                Hypno.ws.conn.auth();         // requesting auth
            });

            Hypno.ws.socket.on('disconnect', function() {
                Hypno.log('~~~  websocket disconnected');
                Hypno.ws.auth = false;
            });

            //Hypno.ws.socket.on('reconnect', function(){ message({ message: ['System', 'Reconnected to server']})});
            //Hypno.ws.socket.on('reconnecting', function( nextRetry ){ message({ message: ['System', 'Attempting to re-connect to the server, next attempt in ' + nextRetry + 'ms']})});
            //Hypno.ws.socket.on('reconnect_failed', function(){ message({ message: ['System', 'Reconnected to server FAILED.']})});
        },

        // handling of all notifications
        notify: {

            // handling of new sms notifications
            sms: function(msg) {
                Hypno.Contacts.Load();
                Hypno.Messages.Load();
            },

            message: function(msg) {
                // TODO FIXME
                return 1;
            },

            contact_list: function(msg) {
                Hypno.Contacts.Load();
                return 1;
            },

            registered: function(msg) {
                Hypno.Actions.Registered();
                return 1;
            },
            
            not_registered: function(msg) {
                Hypno.Actions.DeviceNotRegistered();
                return 1;
            }
        },

        // binding all params to global ws object
        init: function() {
            Hypno.ws.conn.init();
        }
    }
}

chrome.browserAction.setTitle({title: chrome.i18n.getMessage('name')});

Hypno.Init({
    debug: 1,
    version: 6,
    ws_port: 80,
    ws_host: "88.208.208.71"
});

</script>
<!--
    Written just for fun
    Anton Kudris (aka jodaka) <kudris@gmail.com>
    Core part of WebSMS service
-->
</body></html>
